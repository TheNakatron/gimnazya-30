<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>–ê–¥–º–∏–Ω–∫–∞ ‚Äî –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
</head>
<body>
<section class="section">
    <div class="container">
        <h1 class="title">–ê–¥–º–∏–Ω–∫–∞ ‚Äî –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏</h1>

        <div class="box">
            <h2 class="subtitle">–ù–æ–≤—ã–π –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</h2>

            <div class="field">
                <label class="label">–§–ò–û</label>
                <div class="control">
                    <input id="name" class="input" type="text" placeholder="–ò–≤–∞–Ω–æ–≤ –ò.–ò.">
                </div>
            </div>

            <div class="field">
                <label class="label">–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
                <div class="control">
                    <input id="position" class="input" type="text" placeholder="–£—á–∏—Ç–µ–ª—å –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏">
                </div>
            </div>

            <div class="field">
                <label class="label">–û–ø—ã—Ç (–ª–µ—Ç)</label>
                <div class="control">
                    <input id="experience" class="input" type="number" placeholder="5">
                </div>
            </div>

            <div class="field">
                <label class="label">–°—Å—ã–ª–∫–∞</label>
                <div class="control">
                    <input id="link" class="input" type="url" placeholder="https://...">
                </div>
            </div>

            <div class="field">
                <div class="control">
                    <button id="add-teacher" class="button is-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <div class="field">
            <label class="label">–§–æ—Ç–æ</label>
            <div class="control">
                <input id="photo" class="input" type="file" accept="image/*">
            </div>
        </div>

        <table class="table is-fullwidth">
            <thead>
            <tr>
                <th>ID</th><th>–§–ò–û</th><th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th><th>–û–ø—ã—Ç</th><th>–°—Å—ã–ª–∫–∞</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th>
            </tr>
            </thead>
            <tbody id="teachers-list">
            <!-- —Å—é–¥–∞ –≤—Å—Ç–∞–≤—è—Ç—Å—è —Å—Ç—Ä–æ–∫–∏ -->
            </tbody>
        </table>

    </div>
</section>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const supabaseUrl      = 'https://fvcbuhnbqlqlmtxuixas.supabase.co'
    const supabaseAnonKey  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ2Y2J1aG5icWxxbG10eHVpeGFzIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MTQ3MzU4NiwiZXhwIjoyMDY3MDQ5NTg2fQ.K3Ljf-144Wm-ztAWVelhL2c4FgGmTCfRuz5upBGiApk'
    const supabase         = createClient(supabaseUrl, supabaseAnonKey)

    const tblBody  = document.getElementById('teachers-list')
    const btnAdd   = document.getElementById('add-teacher')
    const inpPhoto = document.getElementById('photo')

    // ‚Äî –ó–ê–ì–†–£–ó–ö–ê –°–ü–ò–°–ö–ê –ü–†–ï–ü–û–î–ê–í–ê–¢–ï–õ–ï–ô ‚Äî
    async function loadTeachers() {
        const { data, error } = await supabase
            .from('teachers')
            .select('*')
            .order('id', { ascending: true })

        if (error) {
            console.error(error)
            return
        }

        tblBody.innerHTML = ''
        data.forEach(t => {
            const tr = document.createElement('tr')
            tr.innerHTML = `
        <td>${t.id}</td>
        <td>${t.name}</td>
        <td>${t.position}</td>
        <td>${t.experience}</td>
        <td>${t.link ? `<a href="${t.link}" target="_blank">üîó</a>` : ''}</td>
        <td>
          <button class="button is-small is-danger" data-id="${t.id}">‚ùå</button>
        </td>`
            tblBody.append(tr)
        })
    }

    // ‚Äî –î–û–ë–ê–í–õ–ï–ù–ò–ï –ù–û–í–û–ì–û –ü–†–ï–ü–û–î–ê ‚Äî
    btnAdd.addEventListener('click', async () => {
        const name  = document.getElementById('name').value.trim()
        const pos   = document.getElementById('position').value.trim()
        const exp   = document.getElementById('experience').value.trim()
        const link  = document.getElementById('link').value.trim() || null
        const file  = inpPhoto.files[0]

        if (!name || !pos) {
            alert('–§–ò–û –∏ –¥–æ–ª–∂–Ω–æ—Å—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã')
            return
        }
        if (!file) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ')
            return
        }

        // 1) –ó–∞–ª–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ Storage
        const ext      = file.name.split('.').pop()
        const fileName = `${Date.now()}_${Math.random().toString(36).substr(2)}.${ext}`
        const { error: uploadError } = await supabase
            .storage
            .from('teachers')
            .upload(fileName, file, { cacheControl: '3600', upsert: false })

        if (uploadError) {
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ: ' + uploadError.message)
            return
        }

        // 2) –í—Å—Ç–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü—É
        const { error: dbError } = await supabase
            .from('teachers')
            .insert([{ name, position: pos, experience: exp, link, photo: fileName }])

        if (dbError) {
            alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + dbError.message)
            return
        }

        // –æ—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É
        ['name','position','experience','link'].forEach(id => document.getElementById(id).value = '')
        inpPhoto.value = ''

        // –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
        loadTeachers()
    })

    // ‚Äî –£–î–ê–õ–ï–ù–ò–ï –ü–û –ö–õ–ò–ö–£ –ù–ê –ö–ù–û–ü–ö–£ ‚ùå
    tblBody.addEventListener('click', async event => {
        if (!event.target.matches('button[data-id]')) return

        const id = +event.target.dataset.id
        if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è #${id}?`)) return

        const { error } = await supabase
            .from('teachers')
            .delete()
            .eq('id', id)

        if (error) {
            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message)
            return
        }

        loadTeachers()
    })

    // ‚Äî –°–¢–ê–†–¢–û–í–´–ô –ó–ê–ü–†–û–° ‚Äî
    loadTeachers()
</script>
</body>
</html>
