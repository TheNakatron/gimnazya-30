<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Админка — События</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
          rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css"
  />
</head>
<body>
<section class="section">
  <div class="container">
    <h1 class="title">Админка — События</h1>

    <div class="box">
      <h2 class="subtitle">Новое событие</h2>

      <!-- Главное изображение -->
      <div class="field">
        <label class="label">Главное фото</label>
        <div class="control">
          <input id="main-image" type="file" accept="image/*" class="input" />
        </div>
      </div>

      <!-- Название -->
      <div class="field">
        <label class="label">Заголовок</label>
        <div class="control">
          <input id="title" class="input" type="text" placeholder="Название" />
        </div>
      </div>

      <!-- Описание -->
      <div class="field">
        <label class="label">Описание</label>
        <div class="control">
          <textarea
                  id="description"
                  class="textarea"
                  placeholder="Краткое описание"
          ></textarea>
        </div>
      </div>

      <!-- Дата -->
      <div class="field">
        <label class="label">Дата (ГГГГ-ММ-ДД)</label>
        <div class="control">
          <input id="date" class="input" type="date" />
        </div>
      </div>

      <!-- Галерея -->
      <div class="field">
        <label class="label">Доп. фото (галерея)</label>
        <div class="control">
          <input
                  id="gallery"
                  type="file"
                  accept="image/*"
                  class="input"
                  multiple
          />
        </div>
      </div>

      <!-- Статья или ссылка -->
      <div class="field">
        <label class="label">Статья (текст)</label>
        <div class="control">
          <textarea
                  id="article"
                  class="textarea"
                  placeholder="Полная статья (или оставьте пустым)"
          ></textarea>
        </div>
      </div>
      <div class="field">
        <label class="label">Внешняя ссылка</label>
        <div class="control">
          <input
                  id="ext-link"
                  class="input"
                  type="url"
                  placeholder="https://..."
          />
        </div>
      </div>

      <div class="field">
        <div class="control">
          <button id="add-event" class="button is-primary">
            Добавить событие
          </button>
        </div>
      </div>
    </div>

    <!-- Таблица существующих событий -->
    <table class="table is-fullwidth">
      <thead>
      <tr>
        <th>ID</th><th>Название</th><th>Дата</th><th>Действие</th>
      </tr>
      </thead>
      <tbody id="events-list"></tbody>
    </table>
  </div>
</section>

<script type="module">
  import { createClient } from
            'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

  const SUPABASE_URL     = 'https://fvcbuhnbqlqlmtxuixas.supabase.co'
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ2Y2J1aG5icWxxbG10eHVpeGFzIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MTQ3MzU4NiwiZXhwIjoyMDY3MDQ5NTg2fQ.K3Ljf-144Wm-ztAWVelhL2c4FgGmTCfRuz5upBGiApk'
  const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

  const btnAdd     = document.getElementById('add-event')
  const inpMain    = document.getElementById('main-image')
  const inpTitle   = document.getElementById('title')
  const inpDesc    = document.getElementById('description')
  const inpDate    = document.getElementById('date')
  const inpGal     = document.getElementById('gallery')
  const inpArticle = document.getElementById('article')
  const inpLink    = document.getElementById('ext-link')
  const tbl        = document.getElementById('events-list')

  const loader = document.createElement('progress')
  loader.className = 'progress is-small is-primary mt-3'
  loader.max = 100
  loader.value = 0

  async function compressImage(file, quality = 0.8, maxSize = 1600) {
    const img = new Image()
    img.src = URL.createObjectURL(file)
    await img.decode()

    const canvas = document.createElement('canvas')
    const scale = Math.min(maxSize / img.width, maxSize / img.height, 1)
    canvas.width = img.width * scale
    canvas.height = img.height * scale

    const ctx = canvas.getContext('2d')
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height)

    return new Promise(resolve =>
            canvas.toBlob(blob => resolve(blob), 'image/jpeg', quality)
    )
  }

  async function loadEvents() {
    const { data, error } = await sb
            .from('events')
            .select('*')
            .order('date', { ascending: false })
    if (error) return console.error(error)

    tbl.innerHTML = ''
    data.forEach(e => {
      const tr = document.createElement('tr')
      tr.innerHTML = `
        <td>${e.id}</td>
        <td>${e.title}</td>
        <td>${e.date}</td>
        <td>
          <button class="button is-small is-danger"
                  data-id="${e.id}">
            ❌
          </button>
        </td>`
      tbl.append(tr)
    })
  }

  btnAdd.addEventListener('click', async () => {
    if (!inpMain.files[0] || !inpTitle.value || !inpDate.value) {
      return alert('Главное фото, заголовок и дата обязательны')
    }

    btnAdd.disabled = true
    btnAdd.after(loader)
    loader.value = 10

    // 1) Сжимаем и заливаем главное фото
    const mainFile = inpMain.files[0]
    const compressedMain = await compressImage(mainFile)
    const extMain = 'jpg'
    const keyMain = `events/main_${Date.now()}.${extMain}`
    const { error: upMainErr } = await sb
            .storage
            .from('events')
            .upload(keyMain, compressedMain)
    if (upMainErr) {
      loader.remove()
      btnAdd.disabled = false
      return alert(upMainErr.message)
    }

    loader.value = 30

    // 2) Галерея
    const galFiles = Array.from(inpGal.files)
    const galKeys = []

    for (let i = 0; i < galFiles.length; i++) {
      const f = galFiles[i]
      const comp = await compressImage(f)
      const ext = 'jpg'
      const k = `events/gallery_${Date.now()}_${Math.random().toString(36).slice(2)}.${ext}`
      const { error } = await sb.storage.from('events').upload(k, comp)
      if (error) {
        loader.remove()
        btnAdd.disabled = false
        return alert('Ошибка загрузки галереи: ' + error.message)
      }
      galKeys.push(k)
      loader.value = 30 + Math.round(50 * (i + 1) / galFiles.length)
    }

    // 3) Вставка события
    const { data: [ev], error: evErr } = await sb
            .from('events')
            .insert([{
              title: inpTitle.value,
              description: inpDesc.value || null,
              date: inpDate.value,
              image: keyMain,
              article: inpArticle.value || null,
              link: inpLink.value || null
            }]).select('id')
    if (evErr) {
      loader.remove()
      btnAdd.disabled = false
      return alert(evErr.message)
    }

    loader.value = 90

    // 4) Связь галереи
    for (let pk of galKeys) {
      const { error } = await sb
              .from('event_images')
              .insert([{ event_id: ev.id, image_path: pk }])
      if (error) console.warn('gallery insert error', error)
    }

    loader.value = 100
    setTimeout(() => loader.remove(), 1000)

    // очистка формы
    inpMain.value = ''
    inpTitle.value = ''
    inpDesc.value = ''
    inpDate.value = ''
    inpGal.value = ''
    inpArticle.value = ''
    inpLink.value = ''

    btnAdd.disabled = false
    loadEvents()
  })

  tbl.addEventListener('click', async e => {
    if (!e.target.matches('button[data-id]')) return
    const id = +e.target.dataset.id
    if (!confirm(`Удалить событие #${id}?`)) return

    await sb.from('event_images').delete().eq('event_id', id)
    const { error } = await sb.from('events').delete().eq('id', id)
    if (error) return alert(error.message)

    loadEvents()
  })

  loadEvents()
</script>
</body>
</html>
